<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ include file="/WEB-INF/jsp/common/include/taglib.jspf" %>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<jsp:include page="/WEB-INF/jsp/common/include/default_resources_header.jsp"/>
<jsp:include page="/WEB-INF/jsp/common/include/default_page_script_header.jsp"/>
<jsp:include page="/WEB-INF/jsp/common/include/default_resources_header_override.jsp"/>
<script type="text/javascript">
	
	
	var erpPopupWindowsCell = parent.erpPopupWindows.window("openTellOrderHistoryPopup");
	var erpPopupLayout;
	var erpPopupRibbon;
	var erpPopupGrid;
	var erpPopupGridColumns;
	var erpGridDataProcessor;
	var popOnRowDblClicked;
	var tellInfo = JSON.parse('${tellInfo}');
	
	$(document).ready(function(){
		
		if(erpPopupWindowsCell){
			erpPopupWindowsCell.setText("전화주문");
		}
		init_total_layout();
		init_top_layout();
		init_mid_layout();
		init_bot_layout();
		init_searchPopup();
		
	});
	
	
	
	function init_total_layout(){
		erpPopupLayout = new dhtmlXLayoutObject({
			parent : document.body
			, skin : ERP_LAYOUT_CURRENT_SKINS
			, pattern : "4E"
				, cells : [
					{id: "a", text: "조회일자선택영역", header:false, fix_size : [false, false]}
					,{id: "b", text: "리본영역", header:false, fix_size : [false, false]}
					,{id: "c", text: "그리드영역", header:false, fix_size : [false, false]}
					,{id: "d", text: "ddd영역", header:false, fix_size : [false, false]}
					]
		});
		
		erpPopupLayout.cells("a").attachObject("div_erp_mem_table");
		erpPopupLayout.cells("a").setHeight(60);
		erpPopupLayout.cells("b").attachObject("div_erp_popup_ribbon");
		erpPopupLayout.cells("b").setHeight(ERP_LAYOUT_RIBBON_HEIGHT);
		erpPopupLayout.cells("c").attachObject("div_erp_order_grid");
		erpPopupLayout.cells("d").attachObject("div_erp_sale_table");
		erpPopupLayout.cells("d").setHeight(84);
		erpPopupLayout.setSeparatorSize(0, 1);
		
		<%-- erpPopupLayout 사이즈 변경 시 Event --%>	
		$erp.setEventResizeDhtmlXLayout(erpPopupLayout, function(names){
			erpPopupGrid.setSizes();
		});
	}
	function init_top_layout() {
		cmbORD_STATE = $erp.getDhtmlXComboCommonCode("cmbORD_STATE","ORD_STATE", ["DELI_ORD_STATE"],155, false, false, "D10",null,"Y");
		$erp.objReadonly(["cmbORD_STATE"]);
	}
	function init_mid_layout() {
		erpPopupRibbon = new dhtmlXRibbon({
			parent : "div_erp_popup_ribbon",
			skin : ERP_RIBBON_CURRENT_SKINS,
			icons_path : ERP_RIBBON_CURRENT_ICON_PATH,
			items : [{
				type : "block",
				mode : 'rows',
				list : [ 
						{id : "search_grid", type : "button", text : '조회', isbig : false, img : "menu/search.gif", imgdis : "menu/search_dis.gif", disable : true}
// 						, {id : "add_grid", 	type : "button", text:'<spring:message code="ribbon.add" />', 		isbig : false, img : "menu/add.gif", 	imgdis : "menu/add_dis.gif", 	disable : true}
						, {id : "delete_grid",	type : "button", text:'<spring:message code="ribbon.delete" />', 	isbig : false, img : "menu/delete.gif", imgdis : "menu/delete_dis.gif", disable : true}
						, {id : "save_grid", 	type : "button", text:'<spring:message code="ribbon.save" />', 		isbig : false, img : "menu/save.gif", 	imgdis : "menu/save_dis.gif", 	disable : true}
						]
			}]
		});
		erpPopupRibbon.attachEvent("onClick", function(itemId, bId) {
			if (itemId == "search_grid") {
				init_searchPopup();
			} else if (itemId == "add_grid"){
				if(!validation_check()){
					return;
				}
				var uid = erpPopupGrid.uid();
				erpPopupGrid.addRow(uid);
			} else if (itemId == "delete_grid"){
				if(!validation_check()){
					return;
				}
				
				$erp.dataDeleteOfCheckedGridRow(erpPopupGrid);
			} else if (itemId == "save_grid"){
				if(!validation_check()){
					return;
				}
				saveErpGrid();
			}
		});
	}
	
	function validation_check() {
		var isValidated = true;
		var ORD_STATE = cmbORD_STATE.getSelectedValue();
		var alertMessage = "";
		
		if(ORD_STATE == 'D10'){
			isValidated = false;
			alertMessage = "배송이 완료된 주문입니다<br/>수정하실 수 없습니다.";
		}
		
		if(!isValidated){
			$erp.alertMessage({
				"alertMessage" : alertMessage
				,"alertType" : "alert"
				,"isAjax" : false
// 				,"alertCallbackFn" : function(){ searchErpGrid()}
			});
		} 
		return isValidated;
	}
	
	function init_bot_layout(){
		erpPopupGridColumns = [
			{id : "NO", label:["NO", "#rspan"], type: "cntr", width: "30", sort : "int", align : "center", isHidden : false, isEssential : false}
			, {id : "CHECK", label:["#master_checkbox", "#rspan"], type: "ch", width: "30", sort : "int", align : "center", isHidden : false, isEssential : false, isDataColumn : false}
			,{id : "TEL_ORD_CD", label:["전화주문코드", "#rspan"], type: "ro", width: "60", sort : "str", align : "center", isHidden : true, isEssential : true}
			,{id : "BCD_NM", label:["상품명", "#rspan"], type: "ro", width: "250", sort : "str", align : "left", isHidden : false, isEssential : true}
			,{id : "DIMEN_NM", label:["규격", "#rspan"], type: "ro", width: "60", sort : "str", align : "left", isHidden : false, isEssential : true}
			,{id : "BCD_CD", label:["바코드", "#rspan"], type: "ro", width: "100", sort : "str", align : "left", isHidden : false, isEssential : true}
			,{id : "TEL_SALE_PRICE", label:["판매단가", "#rspan"], type: "ron", width: "50", sort : "int", align : "right", isHidden : false, isEssential : true, numberFormat : "0,000"}
			,{id : "SALE_QTY", label:["수량", "#rspan"], type: "edn", width: "50", sort : "int", align : "right", isHidden : false, isEssential : true}
			,{id : "", label:["특매할인", "#rspan"], type: "edn", width: "50", sort : "int", align : "right", isHidden : false, isEssential : false, numberFormat : "0,000"}
			,{id : "MAST_SALE_PRICE", label:["판매가액", "#rspan"], type: "edn", width: "50", sort : "int", align : "right", isHidden : false, isEssential : false, numberFormat : "0,000"}
			,{id : "", label:["계산유형", "#rspan"], type: "ro", width: "100", sort : "str", align : "left", isHidden : false, isEssential : false}
			,{id : "GRUP_NM", label:["분류", "#rspan"], type: "ro", width: "120", sort : "str", align : "left", isHidden : false, isEssential : true}
			,{id : "ORD_MEMO", label:["메모", "#rspan"], type: "ed", width: "200", sort : "str", align : "left", isHidden : false, isEssential : false}
		];
		
		erpPopupGrid = new dhtmlXGridObject({
			parent: "div_erp_order_grid"
			, skin : ERP_GRID_CURRENT_SKINS
			, image_path : ERP_GRID_CURRENT_IMAGE_PATH
			, columns : erpPopupGridColumns
		});
		
		erpPopupGrid.enableDistributedParsing(true, 100, 50);
		$erp.initGridCustomCell(erpPopupGrid);
		//$erp.initGridComboCell(erpPopupGrid);
		$erp.attachDhtmlXGridFooterPaging(erpPopupGrid, 10);
		$erp.attachDhtmlXGridFooterRowCount(erpPopupGrid, '<spring:message code="grid.allRowCount" />');
		
		erpGridDataProcessor = new dataProcessor();
		erpGridDataProcessor.init(erpPopupGrid);
		erpGridDataProcessor.setUpdateMode("off"); //변경되는 값을 서버에 실시간으로 전송하지 않겠다.
		$erp.initGridDataColumns(erpPopupGrid);
	}
	<%-- popup open했을 때 필요 데이터 --%>
	function init_searchPopup() {
		var MEM_NO = tellInfo.MEM_NO
		var ORGN_CD = tellInfo.ORGN_CD
		var ORGN_DIV_CD = tellInfo.ORGN_DIV_CD;
		var TEL_ORD_CD = tellInfo.TEL_ORD_CD;
		
		erpPopupLayout.progressOn();
		$.ajax({
			url : "/sis/market/sales/getTellOrderinitdata.do"
			,data : {
				"ORGN_DIV_CD" : ORGN_DIV_CD
				,"ORGN_CD" : ORGN_CD
				,"MEM_NO" : MEM_NO
				,"TEL_ORD_CD" : TEL_ORD_CD
			}
			,method : "POST"
			,dataType : "JSON"
			,success : function(data){
				erpPopupLayout.progressOff();
				if(data.isError){
					$erp.ajaxErrorMessage(data);
				} else {
					var mem_table_data = document.getElementById("mem_table_data");
					var price_table_data = document.getElementById("price_table_data");
					$erp.clearInputInElement(mem_table_data);
					$erp.clearInputInElement(price_table_data);
					
					var dataMap = data.dataMap;
					if($erp.isEmpty(dataMap)){//검색 결과 없음
						$erp.alertMessage({
							"alertMessage" : "info.common.noDataSearch"
							, "alertCode" : null
							, "alertType" : "info"
						});
					}else{
						$erp.bindTextValue(dataMap, mem_table_data);
						$erp.bindCmbValue(dataMap, mem_table_data);
					}
					
					var gridDataList = data.gridDataList;
					if($erp.isEmpty(gridDataList)){
						$erp.addDhtmlXGridNoDataPrintRow(
							erpPopupGrid
							, '<spring:message code="grid.noSearchData" />'
						);
					} else {
						erpPopupGrid.parse(gridDataList, 'js');
						$erp.setDhtmlXGridFooterRowCount(erpPopupGrid);
					}
				}
			}, error : function(jqXHR, textStatus, errorThrown){
				erpPopupLayout.progressOff();
				$erp.ajaxErrorHandler(jqXHR, textStatus, errorThrown);
			}
		});
	}
	<%-- 조회버튼 --%>
	function searchErpGrid(){		
		var MEM_NO = tellInfo.MEM_NO;
		var ORGN_CD = tellInfo.ORGN_CD;
		var ORGN_DIV_CD = tellInfo.ORGN_DIV_CD;
		var TEL_ORD_CD = tellInfo.TEL_ORD_CD;
		
		erpPopupLayout.progressOn();
		$.ajax({
			url : "/sis/market/sales/getMemOrderBodydata.do"
			,data : {
					"ORGN_DIV_CD" : ORGN_DIV_CD
					,"ORGN_CD" : ORGN_CD
					,"MEM_NO" : MEM_NO
					,"TEL_ORD_CD" : TEL_ORD_CD
					}
			,method : "POST"
			,dataType : "JSON"
			,success : function(data) {
				erpPopupLayout.progressOff();
				if(data.isError){
					$erp.ajaxErrorMessage(data);
				}else {
					$erp.clearDhtmlXGrid(erpPopupGrid);
					var gridDataList = data.gridDataList;
					if($erp.isEmpty(gridDataList)){
						$erp.addDhtmlXGridNoDataPrintRow(
								erpPopupGrid
								,  '<spring:message code="grid.noSearchData" />'
						);
						return false;
					}else {
						erpPopupGrid.parse(gridDataList, 'js');
						$erp.setDhtmlXGridFooterRowCount(erpPopupGrid);
					}
				}
			}, error : function(jqXHR, textStatus, errorThrown){
				erpPopupLayout.progressOff();
				$erp.ajaxErrorHandler(jqXHR, textStatus, errorThrown);
			}
		});
	}
	
	function saveErpGrid(){
		var gridData = $erp.dataSerializeOfGridByCRUD(erpPopupGrid,true);
		var OUT_WARE_DATE = $("#txtOUT_WARE_DATE").val();
		
		var data1 = {};
		data1["OUT_WARE_DATE"] = OUT_WARE_DATE;
		
		var sumCount_CUD = gridData["C"].length + gridData["U"].length + gridData["D"].length;
		if(sumCount_CUD == 0 && OUT_WARE_DATE == ""){
			$erp.alertMessage({
				"alertMessage" : "변경된 정보가 없습니다.",
				"alertType" : "alert",
				"isAjax" : false
			});
			return;
		}
		var url = "/sis/market/sales/saveTellOrderDetailPopup.do";
		var send_data = $erp.unionObjArray([gridData,data1]);
		
		var if_success = function(data){
			$erp.clearDhtmlXGrid(erpPopupGrid); //기존데이터 삭제
			
			$erp.alertMessage({
				"alertMessage" : "저장성공",
				"alertType" : "alert",
				"isAjax" : false
			});
			
			erpPopupRibbon.callEvent("onClick",["search_grid"]);
		}
		
		var if_error = function(XHR, status, error){
		}
		$erp.UseAjaxRequestInBody(url, send_data, if_success, if_error, erpPopupLayout);
	}
	
</script>
</head>
<body>
	<div id="div_erp_layout" class="div_layout_full_size div_sub_layout" style="display:none">
		<div id="div_erp_mem_table" class="samyang_div" style="diplay:none;">
			<table id="mem_table_data" class="table">
				<colgroup>
					<col width="90px"/>
					<col width="130px"/>
					<col width="90px"/>
					<col width="130px"/>
					<col width="90px"/>
					<col width="130px"/>
					<col width="90px"/>
					<col width="160px"/>
					<col width="90px"/>
					<col width="*"/>
				</colgroup>
				<tr>
					<th colspan="1">주문일시</th>
					<td colspan="1"><input type="text" id="txtORD_DATE" name="KEY_WORD" class="input_common" readonly="readonly" style="width:115px;"></td>
					<th colspan="1">배송일</th>
					<td colspan="1"><input type="text" id="txtOUT_WARE_DATE" name="OUT_WARE_DATE" class="input_calendar default_date" style="width:115px;"></td>
					<th colspan="1">접수자</th>
					<td colspan="1"><input type="text" id="txtORD_RESP_USER" name="KEY_WORD" class="input_common" readonly="readonly" style="width:115px;"></td>
					<th colspan="1">배달 주문 상태</th>
					<td colspan="1"><div id="cmbORD_STATE"></div></td>
					<th colspan="1">외상건수</th>
					<td colspan="1"><input type="text" id="txtTRUST_CNT" name="TRUST_CNT" class="input_common" readonly="readonly" style="text-align:right;width:115px;"></td>
					
				</tr>
				<tr>
					<th colspan="1">회원번호</th>
					<td colspan="1"><input type="text" id="txtMEM_NO" name="MEM_NO" class="input_common" readonly="readonly" style="width: 115px;"></td>
					<th colspan="1">회원명</th>
					<td colspan="1"><input type="text" id="txtMEM_NM" name="MEM_NM" class="input_common" readonly="readonly" style="width: 115px;"></td>
					<th colspan="1">휴대폰 번호</th>
					<td colspan="1"><input type="text" id="txtPHON_NO" name="PHON_NO" class="input_common" readonly="readonly" style="width:115px;"></td>
					<th colspan="1">주소</th>
					<td colspan="1"><input type="text" id="txtDELI_ADDR" name="DELI_ADDR" class="input_common" readonly="readonly" style="width:145px;"></td>
					<th colspan="1">여신잔액</th>
					<td colspan="1"><input type="text" id="txtBAL_AMT" name="BAL_AMT" class="input_common" readonly="readonly" style="text-align:right;width:115px;"></td>
					
<!-- 					<th colspan="1">배송지 상세주소</th> -->
<!-- 					<td colspan="1"><input type="text" id="txtDELI_ADDR_DETL" name="DELI_ADDR_DETL" class="input_common" readonly="readonly" style="width:115px;"></td> -->
				</tr>
			</table>
		</div>
		<div id="div_erp_popup_ribbon" class="div_ribbon_full_size" style="display:none"></div>
		<div id="div_erp_order_grid" class="div_grid_full_size" style="display:none"></div>
		
			<div id="div_erp_sale_table" class="samyang_div" style="diplay:none;">
				<table id="price_table_data" class="table" >
					<colgroup>
						<col width="">
					</colgroup>
					<tr>
						<th style="text-align:left;">과세물품공급가</th>
						<td colspan="1">
							<input type="text" id="SALE_QTY" name="SALE_QTY" class="input_common input_readonly" readonly="readonly" value = "0" style="width: 140px; text-align:right;">
						</td>
						<th style="text-align:left;">과세보증금</th>
						<td colspan="1">
							<input type="text" id="SALE_AMT" name="SALE_AMT" class="input_common input_readonly" readonly="readonly"  value = "0" style="width: 140px; text-align:right;">
						</td>
						<th style="text-align:left;">과세판매</th>
						<td colspan="1">
							<input type="text" id="COUP_AMT" name="COUP_AMT" class="input_common input_readonly" readonly="readonly"  value = "0" style="width: 140px; text-align:right;">
						</td>
					</tr>
					<tr>
						<th style="text-align:left;">면세물품공급가</th>
						<td colspan="1">
							<input type="text" id="RETURN_QTY" name="RETURN_QTY" class="input_common input_readonly" readonly="readonly" value = "0" style="width: 140px; text-align:right;">
						</td>
						<th style="text-align:left;">면세보증금</th>
						<td colspan="1">
							<input type="text" id="RETN_AMT" name="RETN_AMT" class="input_common input_readonly" readonly="readonly" value = "0" style="width: 140px; text-align:right;">
						</td>
						<th style="text-align:left;">면세판매</th>
						<td colspan="1">
							<input type="text" id="BARG_AMT" name="BARG_AMT" class="input_common input_readonly" readonly="readonly" value = "0" style="width: 140px; text-align:right;">
						</td>
					</tr>
					<tr>
						<th style="text-align:left;">물품공급가합계</th>
						<td colspan="1">
							<input type="text" id="RETURN_QTY" name="RETURN_QTY" class="input_common input_readonly" readonly="readonly" value = "0" style="width: 140px; text-align:right;">
						</td>
						<th style="text-align:left;">보증금합계</th>
						<td colspan="1">
							<input type="text" id="RETN_AMT" name="RETN_AMT" class="input_common input_readonly" readonly="readonly" value = "0" style="width: 140px; text-align:right;">
						</td>
						<th style="text-align:left;">부가세</th>
						<td colspan="1">
							<input type="text" id="BARG_AMT" name="BARG_AMT" class="input_common input_readonly" readonly="readonly" value = "0" style="width: 140px; text-align:right;">
						</td>
					</tr>
				</table>
			</div>
	</div>
	
</body>
</html>