<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.samyang.winplus.sis.order.dao.PurchaseCloseDao">
	<select id="getSuprByPurchaseHeaderList" resultType="java.util.Map" parameterType="java.util.Map">
		/* getSuprByPurchaseHeaderList */
		SELECT
			CONVERT(NVARCHAR(10),CSC.YMD,23) AS YMD
			,WINP.ORGN_DIV_CD
			,WINP.ORGN_CD
			,WINP.SUPR_CD
			,WINP.PUR_DATE
			,WINP.TOT_GOODS_NM
			,WINP.TOT_SUPR_AMT
			,WINP.TOT_VAT
			,WINP.TOT_PAY_SUM_AMT
			,WINP.CONF_TYPE
			,WINP.SEND_TYPE
			,CUSTMR.CLSE_SUPR_AMT
			,CUSTMR.CLSE_VAT
			,CUSTMR.CLSE_TOT_AMT
			,(WINP.TOT_PAY_SUM_AMT - CUSTMR.CLSE_TOT_AMT) AS CALC_AMT
			,WINP.TOT_TAXA_SUPR_AMT
			,WINP.TOT_TAXA_VAT
			,WINP.TOT_TAXA_PAY_SUM_AMT
			,WINP.TOT_FREE_SUPR_AMT
		FROM COM_SYSTEM_CALENDAR CSC
		LEFT OUTER JOIN (
			SELECT
				A.ORGN_DIV_CD
				,A.ORGN_CD
				,A.SUPR_CD
				,A.PUR_DATE
				,CASE
					WHEN COUNT(A.BCD_CD) > 1 THEN CONCAT((SELECT BCD_NM FROM T_STD_MAST_BCD WHERE BCD_CD = MAX(A.BCD_CD)),' 외 ',(COUNT(A.BCD_CD)-1),'건')
					ELSE (SELECT BCD_NM FROM T_STD_MAST_BCD WHERE BCD_CD = MAX(A.BCD_CD))
				END AS TOT_GOODS_NM
				,SUM(A.SUPR_AMT) AS TOT_SUPR_AMT
				,SUM(A.VAT) AS TOT_VAT
				,SUM(A.PAY_SUM_AMT) AS TOT_PAY_SUM_AMT
				,A.CONF_TYPE
				,A.SEND_TYPE
				,SUM(A.TAXA_SUPR_AMT) AS TOT_TAXA_SUPR_AMT
				,SUM(A.TAXA_VAT) AS TOT_TAXA_VAT
				,SUM(A.TAXA_PAY_SUM_AMT) AS TOT_TAXA_PAY_SUM_AMT
				,SUM(A.FREE_SUPR_AMT) AS TOT_FREE_SUPR_AMT
			FROM (
				SELECT
					PM.ORGN_DIV_CD
					,PM.ORGN_CD
					,PM.SUPR_CD
					,PM.PUR_DATE
					,PD.BCD_CD
					,COUNT(PD.BCD_CD) AS CNT
					,SUM(
						CASE
							WHEN PM.PUR_TYPE = 'P' THEN PD.SUPR_AMT * 1
							WHEN PM.PUR_TYPE = 'R' THEN PD.SUPR_AMT * -1
							ELSE 0
						END
					) AS SUPR_AMT
					,SUM(
						CASE
							WHEN PM.PUR_TYPE = 'P' THEN PD.VAT * 1
							WHEN PM.PUR_TYPE = 'R' THEN PD.VAT * -1
							ELSE 0
						END
					) AS VAT
					,SUM(
						CASE
							WHEN PM.PUR_TYPE = 'P' THEN PD.PAY_SUM_AMT * 1
							WHEN PM.PUR_TYPE = 'R' THEN PD.PAY_SUM_AMT * -1
							ELSE 0
						END
					) AS PAY_SUM_AMT
					,PM.CONF_TYPE
					,ISNULL(PM.SEND_TYPE,'N') AS SEND_TYPE
					,SUM(
						CASE
							WHEN PM.PUR_TYPE = 'P' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'Y' THEN PD.SUPR_AMT * 1 ELSE 0 END)
							WHEN PM.PUR_TYPE = 'R' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'Y' THEN PD.SUPR_AMT * -1 ELSE 0 END)
							ELSE 0
						END
					) AS TAXA_SUPR_AMT
					,SUM(
						CASE
							WHEN PM.PUR_TYPE = 'P' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'Y' THEN PD.VAT * 1 ELSE 0 END)
							WHEN PM.PUR_TYPE = 'R' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'Y' THEN PD.VAT * -1 ELSE 0 END)
							ELSE 0
						END
					) AS TAXA_VAT
					,SUM(
						CASE
							WHEN PM.PUR_TYPE = 'P' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'Y' THEN PD.PAY_SUM_AMT * 1 ELSE 0 END)
							WHEN PM.PUR_TYPE = 'R' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'Y' THEN PD.PAY_SUM_AMT * -1 ELSE 0 END)
							ELSE 0
						END
					) AS TAXA_PAY_SUM_AMT
					,SUM(
						CASE
							WHEN PM.PUR_TYPE = 'P' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'N' THEN PD.SUPR_AMT * 1 ELSE 0 END)
							WHEN PM.PUR_TYPE = 'R' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'N' THEN PD.SUPR_AMT * -1 ELSE 0 END)
							ELSE 0
						END
					) AS FREE_SUPR_AMT
				FROM T_PUR_MAST PM
				INNER JOIN T_PUR_DETL PD
				ON PM.ORGN_DIV_CD = PD.ORGN_DIV_CD
				AND PM.ORGN_CD = PD.ORGN_CD
				AND PM.PUR_SLIP_CD = PD.PUR_SLIP_CD
				WHERE PM.PUR_DATE BETWEEN #{searchDateFrom} AND #{searchDateTo}
				AND PM.ORGN_CD = #{ORGN_CD}
				AND PM.SUPR_CD = #{SUPR_CD}
				AND PM.USE_YN = 'Y'
				AND PD.USE_YN = 'Y'
				GROUP BY PM.ORGN_DIV_CD,PM.ORGN_CD,PM.SUPR_CD,PM.PUR_DATE,PD.BCD_CD,PM.CONF_TYPE,PM.SEND_TYPE
			) A
			GROUP BY A.ORGN_DIV_CD,A.ORGN_CD,A.SUPR_CD,A.PUR_DATE,A.CONF_TYPE,A.SEND_TYPE
		) WINP
		ON CSC.YYYYMMDD = WINP.PUR_DATE
		LEFT OUTER JOIN (
			SELECT
				ORGN_CD
				,CUSTMR_CD
				,CLSE_DATE
				,CLSE_SUPR_AMT
				,CLSE_VAT
				,CLSE_TOT_AMT
			FROM T_CLSE_CUSTMR_TMP CCT
			WHERE CCT.CLSE_DATE BETWEEN #{searchDateFrom} AND #{searchDateTo}
			AND CCT.ORGN_CD = #{ORGN_CD}
			AND CCT.CUSTMR_CD = #{SUPR_CD}
		) CUSTMR
		ON CSC.YYYYMMDD = CUSTMR.CLSE_DATE
		WHERE CSC.YYYYMMDD BETWEEN #{searchDateFrom} AND #{searchDateTo}
	</select>
	
	<select id="getSuprByPurchaseDetailList" resultType="java.util.Map" parameterType="java.util.Map">
		/* getSuprByPurchaseDetailList */
		SELECT
			PM.PUR_SLIP_CD
			,PD.PUR_SLIP_SEQ
			,PD.BCD_CD
			,SMB.BCD_NM
			,SMB.DIMEN_NM
			,PD.PUR_PRICE
			,PD.PUR_QTY
			,(
				CASE
					WHEN PM.PUR_TYPE = 'P' THEN PD.SUPR_AMT * 1
					WHEN PM.PUR_TYPE = 'R' THEN PD.SUPR_AMT * -1
					ELSE 0
				END
			) AS SUPR_AMT
			,(
				CASE
					WHEN PM.PUR_TYPE = 'P' THEN PD.VAT * 1
					WHEN PM.PUR_TYPE = 'R' THEN PD.VAT * -1
					ELSE 0
				END
			) AS VAT
			,(
				CASE
					WHEN PM.PUR_TYPE = 'P' THEN PD.PAY_SUM_AMT * 1
					WHEN PM.PUR_TYPE = 'R' THEN PD.PAY_SUM_AMT * -1
					ELSE 0
				END
			) AS PAY_SUM_AMT
			,PD.GOODS_TAX_YN
			,(
				CASE
					WHEN PM.PUR_TYPE = 'P' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'Y' THEN PD.SUPR_AMT * 1 ELSE 0 END)
					WHEN PM.PUR_TYPE = 'R' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'Y' THEN PD.SUPR_AMT * -1 ELSE 0 END)
					ELSE 0
				END
			) AS TAXA_SUPR_AMT
			,(
				CASE
					WHEN PM.PUR_TYPE = 'P' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'Y' THEN PD.VAT * 1 ELSE 0 END)
					WHEN PM.PUR_TYPE = 'R' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'Y' THEN PD.VAT * -1 ELSE 0 END)
					ELSE 0
				END
			) AS TAXA_VAT
			,(
				CASE
					WHEN PM.PUR_TYPE = 'P' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'Y' THEN PD.PAY_SUM_AMT * 1 ELSE 0 END)
					WHEN PM.PUR_TYPE = 'R' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'Y' THEN PD.PAY_SUM_AMT * -1 ELSE 0 END)
					ELSE 0
				END
			) AS TAXA_PAY_SUM_AMT
			,(
				CASE
					WHEN PM.PUR_TYPE = 'P' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'N' THEN PD.SUPR_AMT * 1 ELSE 0 END)
					WHEN PM.PUR_TYPE = 'R' THEN (CASE WHEN ISNULL(PD.GOODS_TAX_YN,'N') = 'N' THEN PD.SUPR_AMT * -1 ELSE 0 END)
					ELSE 0
				END
			) AS FREE_SUPR_AMT
		FROM T_PUR_MAST PM
		INNER JOIN T_PUR_DETL PD
		ON PM.ORGN_DIV_CD = PD.ORGN_DIV_CD
		AND PM.ORGN_CD = PD.ORGN_CD
		AND PM.PUR_SLIP_CD = PD.PUR_SLIP_CD
		INNER JOIN T_STD_MAST_BCD SMB
		ON PD.BCD_CD = SMB.BCD_CD
		WHERE PM.CONF_TYPE = 'N'
		AND PM.PUR_DATE = #{PUR_DATE}
		AND PM.ORGN_CD = #{ORGN_CD}
		AND PM.SUPR_CD = #{SUPR_CD}
		AND PM.USE_YN = 'Y'
		AND PD.USE_YN = 'Y'
		ORDER BY PM.PUR_SLIP_CD,PD.PUR_SLIP_SEQ
	</select>
	
	<select id="approvalSuprByPurchase" resultType="java.lang.String" parameterType="java.util.Map">
		/* approvalSuprByPurchase */
		DECLARE @SELECT_CNT INT
				,@UPDATE_CNT INT
		
		SET @SELECT_CNT = (
							SELECT COUNT(PUR_DATE) FROM T_PUR_MAST
							WHERE ORGN_CD = #{ORGN_CD}
							AND SUPR_CD = #{SUPR_CD}
							AND PUR_DATE = #{PUR_DATE}
							AND ISNULL(CONF_TYPE,'N') = 'N'
							AND ISNULL(SEND_TYPE,'N') != 'Y'
						)
		
		UPDATE T_PUR_MAST
		SET CONF_TYPE = 'Y'
			, MPROGRM = 'approvalSuprByPurchase'
			, MDATE = GETDATE()
			, MUSER = #{RESP_USER}
		WHERE ORGN_CD = #{ORGN_CD}
		AND SUPR_CD = #{SUPR_CD}
		AND PUR_DATE = #{PUR_DATE}
		AND ISNULL(CONF_TYPE,'N') = 'N'
		AND ISNULL(SEND_TYPE,'N') != 'Y'
		
		SET @UPDATE_CNT = @@ROWCOUNT

		IF(@SELECT_CNT = @UPDATE_CNT AND @UPDATE_CNT >= 1)
			BEGIN
				SELECT 'SUCCESS' AS RESULT_MSG
				
				UPDATE T_CLSE_CUSTMR_TMP
				SET CONF_TYPE = 'Y'
					, MPROGRM = 'approvalSuprByPurchase'
					, MDATE = GETDATE()
					, MUSER = #{RESP_USER}
				WHERE ORGN_CD = #{ORGN_CD}
				AND CUSTMR_CD = #{SUPR_CD}
				AND CLSE_DATE = #{PUR_DATE}
				AND PUR_SALE_TYPE = '1'
			END
		ELSE
			BEGIN
				SELECT 'FAIL' AS RESULT_MSG
			END
	</select>
	
	<select id="cancelSuprByPurchase" resultType="java.lang.String" parameterType="java.util.Map">
		/* cancelSuprByPurchase */
		DECLARE @SELECT_CNT INT
				,@UPDATE_CNT INT
		
		SET @SELECT_CNT = (
							SELECT COUNT(PUR_DATE) FROM T_PUR_MAST
							WHERE ORGN_CD = #{ORGN_CD}
							AND SUPR_CD = #{SUPR_CD}
							AND PUR_DATE = #{PUR_DATE}
							AND ISNULL(CONF_TYPE,'N') = 'Y'
							AND ISNULL(SEND_TYPE,'N') != 'Y'
						)
		
		UPDATE T_PUR_MAST
		SET CONF_TYPE = 'N'
			, MPROGRM = 'cancelSuprByPurchase'
			, MDATE = GETDATE()
			, MUSER = #{RESP_USER}
		WHERE ORGN_CD = #{ORGN_CD}
		AND SUPR_CD = #{SUPR_CD}
		AND PUR_DATE = #{PUR_DATE}
		AND ISNULL(CONF_TYPE,'N') = 'Y'
		AND ISNULL(SEND_TYPE,'N') != 'Y'
		
		SET @UPDATE_CNT = @@ROWCOUNT

		IF(@SELECT_CNT = @UPDATE_CNT AND @UPDATE_CNT >= 1)
			BEGIN
				SELECT 'SUCCESS' AS RESULT_MSG
				
				UPDATE T_CLSE_CUSTMR_TMP
				SET CONF_TYPE = 'N'
					, MPROGRM = 'approvalSuprByPurchase'
					, MDATE = GETDATE()
					, MUSER = #{RESP_USER}
				WHERE ORGN_CD = #{ORGN_CD}
				AND CUSTMR_CD = #{SUPR_CD}
				AND CLSE_DATE = #{PUR_DATE}
				AND PUR_SALE_TYPE = '1'
			END
		ELSE
			BEGIN
				SELECT 'FAIL' AS RESULT_MSG
			END
	</select>

</mapper>